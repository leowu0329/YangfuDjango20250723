{% extends 'base.html' %}
{% load static %}
{% load urlify %}

{% comment %} 標籤名稱 {% endcomment %}
{% block head_title %} 首頁 {% endblock head_title %}

{% comment %} 在此建立CSS {% endcomment %}
{% block customize_style %}
body {
  background: linear-gradient(135deg, #f8fafc 0%, #e0eafc 100%);
  font-family: "Noto Sans TC", Roboto, Arial, "Microsoft JhengHei", "微軟正黑體", sans-serif;
}

.heading {
  font-size: 2.5rem;
  color: #2d4059;
  font-weight: bold;
  margin-bottom: 2rem;
  border-bottom: 3px solid #30aadd;
  padding-bottom: 0.5rem;
  letter-spacing: 2px;
}

.table-container {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
  padding: 2rem;
  margin-top: 2rem;
}

.table thead {
  background: linear-gradient(90deg, #30aadd 0%, #36d1c4 100%);
  color: #fff;
}

.table tbody tr {
  transition: background 0.2s;
}
.table tbody tr:hover {
  background: #e0f7fa;
}

.table th, .table td {
  border: none;
  padding: 1rem 0.5rem;
}

.accordion {
  background: #30aadd;
  color: #fff;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(48,170,221,0.08);
  transition: background 0.2s;
}
.accordion.active, .accordion:hover {
  background: #36d1c4;
}

.panel {
  border-radius: 0 0 8px 8px;
  box-shadow: 0 2px 8px rgba(48,170,221,0.08);
  margin-bottom: 1rem;
  padding: 1rem;
}

.btn {
  border-radius: 6px !important;
  font-weight: 600;
  letter-spacing: 1px;
  box-shadow: 0 2px 8px rgba(48,170,221,0.08);
}

@media (max-width:764px){
  .table-container{display: none;}
  .table-accordion{display: block; }
  .accordion {
    background: #30aadd;
    color: #fff;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(48,170,221,0.08);
    transition: background 0.2s;
  }
  .accordion.active, .accordion:hover {
    background: #36d1c4;
  }
  .panel {
    border-radius: 0 0 8px 8px;
    box-shadow: 0 2px 8px rgba(48,170,221,0.08);
    margin-bottom: 1rem;
    padding: 1rem;
  }
  .row-content{
    border-bottom: 1px dashed #30aadd;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
  }
  .row-button {
    margin: 5px auto;
  }
  .row-button a {
    font-size: 1.1rem;
    margin: 0px;
    width: 80%;
  }
}
{% endblock customize_style %}

{% comment %} 在此建立Content {% endcomment %}
{% block content %}
<div>
  <!-- 搜尋欄 -->
  <div class="row pt-3" >
    <div class="col pt-2">
      <p class="fs-3 text-center text-sm-start mt-1 pb-1 fw-bold">案件清單</p>
    </div>
    <div class="col-md-10">
      <form action="" method="GET" class="input-group mb-3 col">
        <input type="text" name="q" class="form-control border border-secondary" placeholder="模糊比對(案號、住址、負責人、最終判定...等)" aria-label="Recipient's username" aria-describedby="button-addon2" value='{{ request.GET.q }}'>
        <input type="submit" class="btn btn-primary" value="搜尋">
      </form>
    </div>
  </div>


  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>案號</th>
          <th>兩週內<br>應買止日</th>
          <th>負責人</th>
          <th>最終判定</th>
          <th>執行結果</th>
          <th>優購結果</th>
          <th>標的編號</th>
        </tr>
      </thead>
      <tbody>
        {% for yfcase in object_list %}
          <tr>
            <td data-label="案號" class="yfcase__number">
              <a href="{% url 'yfcase:yfcase_detail' yfcase.id %}" style="text-decoration: none;" >
                {{yfcase.yfcaseCaseNumber}}
                <br>
                <div class="text-address text-secondary">
                   &emsp;&#10149;{{yfcase.fullAddress}}
                </div>

              </a>
            </td>
            <td data-label="兩週內/應買止日" style="color:red;">
             <!-- 兩週內 -->
              {% for finaldecision in yfcase.finaldecisions.all %}
                {% if yfcase.get_auction_1st.auctionDateFirst and finaldecision.finalDecision == '1拍進場' %}
                  {{ yfcase.get_auction_1st.auctionDateFirst|less_two_week:"1拍"|default_if_none:"" }}
                {% endif %}
                {% if yfcase.get_auction_2nd.auctionDateSecond and finaldecision.finalDecision == '2拍進場' %}
                  {{ yfcase.get_auction_2nd.auctionDateSecond|less_two_week:"2拍"|default_if_none:"" }}
                {% endif %}
                {% if yfcase.get_auction_3rd.auctionDateThird and finaldecision.finalDecision == '3拍進場' %}
                  {{ yfcase.get_auction_3rd.auctionDateThird|less_two_week:"3拍"|default_if_none:"" }}
                {% endif %}
                {% if yfcase.get_auction_4th.auctionDateFourth and finaldecision.finalDecision == '4拍進場' %}
                  {{ yfcase.get_auction_4th.auctionDateFourth|less_two_week:"4拍"|default_if_none:"" }}
                {% endif %}
              {% endfor %}
              <!-- 應買止日 -->
              {% for result in yfcase.get_result_stopBuyDate %}
                {{ result.stopBuyDate|less_three_month:"應買止日"|default_if_none:"" }}
              {% endfor %}  
            </td>
            <td data-label="負責人">
              {{ yfcase.user.userFullName|otherName }}
            </td>
            <td data-label="最終判定">
              {% for finaldecision in yfcase.finaldecisions.all %}
                  {{ finaldecision.finalDecision }}<br>
              {% endfor %}
            </td>
            <td data-label="執行結果">
              {% for result in yfcase.results.all %}
                {% if result.actionResult == '等待優購' or result.actionResult == '遭優購' or result.actionResult == '無人優購' %}
                  得標
                {% else %}
                  {{ result.actionResult|default_if_none:"" }}
                {% endif %}
              {% endfor %}
            </td>
            <td data-label="優購結果">
              {% for result in yfcase.results.all %}
                {% if result.actionResult == '等待優購' or result.actionResult == '遭優購' or result.actionResult == '無人優購' %}
                  {{ result.actionResult }}
                {% endif %}
              {% endfor %}
            </td>
            <td data-label="標的編號">
              {% for result in yfcase.results.all %}
                {{ result.objectNumber|default_if_none:"" }}
              {% endfor %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="table-accordion">
      {% for yfcase in object_list %}
        <button class="accordion">
          {{yfcase.yfcaseCaseNumber}}
          <br>
          &emsp;&#10149;{{yfcase.fullAddress}}
        </button>
        <div class="panel border-start border-secondary border-3">
          <div class="row row-content fw-bolder">
            <div class="col-3 text-dark bg-warning">兩週內/應買日</div>
            <div class="col-6" style="color:red;">
              <!-- 兩週內 -->
              {% for finaldecision in yfcase.finaldecisions.all %}
                {% if yfcase.get_auction_1st.auctionDateFirst and finaldecision.finalDecision == '1拍進場' %}
                  {{ yfcase.get_auction_1st.auctionDateFirst|less_two_week:"1拍"|default_if_none:"" }}
                {% endif %}
                {% if yfcase.get_auction_2nd.auctionDateSecond and finaldecision.finalDecision == '2拍進場' %}
                  {{ yfcase.get_auction_2nd.auctionDateSecond|less_two_week:"2拍"|default_if_none:"" }}
                {% endif %}
                {% if yfcase.get_auction_3rd.auctionDateThird and finaldecision.finalDecision == '3拍進場' %}
                  {{ yfcase.get_auction_3rd.auctionDateThird|less_two_week:"3拍"|default_if_none:"" }}
                {% endif %}
                {% if yfcase.get_auction_4th.auctionDateFourth and finaldecision.finalDecision == '4拍進場' %}
                  {{ yfcase.get_auction_4th.auctionDateFourth|less_two_week:"4拍"|default_if_none:"" }}
                {% endif %}
              {% endfor %}
              <!-- 應買止日 -->
              {% for result in yfcase.get_result_stopBuyDate %}
                {{ result.stopBuyDate|less_three_month:"應買止日"|default_if_none:"" }}
              {% endfor %}  
            </div>
          </div>
          <div class="row row-content fw-bolder">
            <div class="col-3 text-dark bg-warning">負責人</div>
            <div class="col-6">{{ yfcase.user }}</div>
          </div>
          <div class="row row-content fw-bolder">
            <div class="col-3 text-dark bg-warning">最終判定</div>
            <div class="col-6">
              {% for finaldecision in yfcase.finaldecisions.all %}
                {{ finaldecision.finalDecision }}<br>
              {% endfor %}  
            </div>
          </div>
          <div class="row row-content fw-bolder">
            <div class="col-3 text-dark bg-warning">執行結果</div>
            <div class="col-6">
              {% for result in yfcase.results.all %}
                {% if result.actionResult == '等待優購' or result.actionResult == '遭優購' or result.actionResult == '無人優購' %}
                  得標
                {% else %}
                  {{ result.actionResult|default_if_none:"" }}
                {% endif %}
              {% endfor %} 
            </div>
          </div>
          <div class="row row-content fw-bolder">
            <div class="col-3 text-dark bg-warning">優購結果</div>
            <div class="col-6">
              {% for result in yfcase.results.all %}
                {% if result.actionResult == '等待優購' or result.actionResult == '遭優購' or result.actionResult == '無人優購' %}
                  {{ result.actionResult }}
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <div class="row row-content fw-bolder">
            <div class="col-3 text-dark bg-warning">標的編號</div>
            <div class="col-6">
              {% for result in yfcase.results.all %}
                {{ result.objectNumber|default_if_none:"" }}
              {% endfor %}
            </div>
          </div>
          <div class="row row-button">

            <div class="col-6 justify-content-center">
              <a href="{% url 'yfcase:yfcase_detail' yfcase.id %}" class="btn btn-secondary btn-sm" >
                查看(編輯)明細
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
  </div>
  {% include "pagination.html" %}
</div>
{% endblock %}

{% comment %} 在此建立JS {% endcomment %}
{% block customize_js %}
var acc = document.getElementsByClassName("accordion");
  var i;

  for (i = 0; i < acc.length; i++) {
    acc[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var panel = this.nextElementSibling;
      if (panel.style.maxHeight) {
        panel.style.maxHeight = null;
      } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
      } 
    });
  }
{% endblock customize_js %}